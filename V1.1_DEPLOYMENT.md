# Platform v1.1 Deployment Guide

## Summary

Platform v1.1 adds ERPNext (ERP system) and n8n (workflow automation) as demo applications running on the same VPS behind the existing Traefik reverse proxy.

## Prerequisites

- Existing platform stack running (Traefik, ai-api, ui, postgres, qdrant)
- Docker network "platform" exists
- DNS records configured:
  - `erp.demo.helioncity.com` → VPS IP
  - `n8n.demo.helioncity.com` → VPS IP
- Sufficient disk space (ERPNext requires ~2GB for initial setup)

## Quick Deploy (Copy + Edit + Deploy)

```bash
cd /opt/ai-erp-platform
git pull
cd infra
cp .env.demo-apps.example .env.demo-apps
nano .env.demo-apps   # Edit secrets (see checklist below)
docker compose -f docker-compose.demo-apps.yml --env-file .env.demo-apps up -d
docker compose -f docker-compose.demo-apps.yml --env-file .env.demo-apps ps
docker compose -f docker-compose.demo-apps.yml --env-file .env.demo-apps logs --tail=200 erpnext
```

## Deployment Commands (Detailed)

### 1. Navigate to project directory

```bash
cd /opt/ai-erp-platform
git pull
cd infra
```

### 2. Copy environment template

```bash
cp .env.demo-apps.example .env.demo-apps
```

### 3. Edit environment file

```bash
nano .env.demo-apps
```

**Required changes (checklist):**
- [ ] `N8N_BASIC_AUTH_USER` - Set to desired username (default: admin)
- [ ] `N8N_BASIC_AUTH_PASSWORD` - Set to secure password (REQUIRED)
- [ ] `ERPNEXT_DB_ROOT_PASSWORD` - Set to secure MariaDB root password (REQUIRED)
- [ ] `ERPNEXT_DB_PASSWORD` - Set to secure database password (REQUIRED)
- [ ] `ERPNEXT_ADMIN_PASSWORD` - Set to secure ERPNext admin password (REQUIRED)

**Optional (already have defaults):**
- `N8N_HOST` - Default: n8n.demo.helioncity.com
- `ERPNEXT_SITE_NAME` - Default: erp.demo.helioncity.com
- `ERPNEXT_VERSION` - Default: v15.0.0

### 4. Start demo apps

```bash
docker compose -f docker-compose.demo-apps.yml --env-file .env.demo-apps up -d
```

### 5. Monitor startup (ERPNext takes 5-10 minutes on first run)

```bash
# Watch all services
docker compose -f docker-compose.demo-apps.yml --env-file .env.demo-apps logs -f

# Watch specific service
docker compose -f docker-compose.demo-apps.yml --env-file .env.demo-apps logs -f erpnext
docker compose -f docker-compose.demo-apps.yml --env-file .env.demo-apps logs -f n8n
```

### 6. Verify services are running

```bash
docker compose -f docker-compose.demo-apps.yml --env-file .env.demo-apps ps
```

**Expected output:**
```
NAME              STATUS
erpnext           Up (healthy)
erpnext-db        Up (healthy)
erpnext-redis     Up (healthy)
n8n               Up
```

## First-Time ERPNext Site Creation

If automatic site creation fails or you need to recreate the site:

### Option 1: Automatic (via command in docker-compose)

The compose file includes automatic site creation. If it fails, check logs:

```bash
docker compose -f docker-compose.demo-apps.yml logs erpnext | grep -i "site\|error\|bench"
```

### Option 2: Manual site creation

```bash
# Enter ERPNext container
docker compose -f docker-compose.demo-apps.yml exec erpnext bash

# Initialize bench (if not already done)
bench init frappe-bench --frappe-branch v15.0.0

# Create new site
bench new-site erp.demo.helioncity.com \
  --db-root-password ${ERPNEXT_DB_ROOT_PASSWORD} \
  --admin-password ${ERPNEXT_ADMIN_PASSWORD} \
  --install-app erpnext

# Start bench serve (if not running)
bench serve --host 0.0.0.0 --port 8000

# Exit container
exit
```

### Option 3: Using bench commands from host

```bash
# Get environment variables
source .env.demo-apps

# Execute bench commands in container
docker compose -f docker-compose.demo-apps.yml exec erpnext \
  bench new-site erp.demo.helioncity.com \
  --db-root-password ${ERPNEXT_DB_ROOT_PASSWORD} \
  --admin-password ${ERPNEXT_ADMIN_PASSWORD} \
  --install-app erpnext
```

## Verification Commands

### 1. Test HTTPS endpoints

```bash
# Test ERPNext HTTPS
curl -I https://erp.demo.helioncity.com
# Expected: HTTP/2 200 OK (or 302 redirect to login)

# Test n8n HTTPS (should prompt for basic auth)
curl -I https://n8n.demo.helioncity.com
# Expected: HTTP/2 401 Unauthorized (basic auth required)

# Test n8n with basic auth
curl -I -u "admin:your-password" https://n8n.demo.helioncity.com
# Expected: HTTP/2 200 OK
```

### 2. Test HTTP to HTTPS redirect

```bash
# Test ERPNext redirect
curl -I http://erp.demo.helioncity.com
# Expected: HTTP/1.1 307 Temporary Redirect
#          Location: https://erp.demo.helioncity.com/

# Test n8n redirect
curl -I http://n8n.demo.helioncity.com
# Expected: HTTP/1.1 307 Temporary Redirect
#          Location: https://n8n.demo.helioncity.com/
```

### 3. Test internal routing (from VPS)

```bash
# Test ERPNext via Traefik
curl -s -H "Host: erp.demo.helioncity.com" http://127.0.0.1/
# Expected: HTML content or redirect

# Test n8n via Traefik
curl -s -H "Host: n8n.demo.helioncity.com" http://127.0.0.1/
# Expected: HTML content or redirect
```

### 4. Check Traefik discovered services

```bash
# Check n8n router
curl -s http://localhost:8080/api/http/routers | jq '.[] | select(.name | contains("n8n"))'

# Check ERPNext router
curl -s http://localhost:8080/api/http/routers | jq '.[] | select(.name | contains("erpnext"))'
```

**Expected:** Should show `n8n-http`, `n8n-https`, `erpnext-http`, `erpnext-https` routers.

### 5. Check container health

```bash
# Check ERPNext database
docker compose -f docker-compose.demo-apps.yml exec erpnext-db \
  mysql -u root -p${ERPNEXT_DB_ROOT_PASSWORD} -e "SHOW DATABASES;"

# Check Redis
docker compose -f docker-compose.demo-apps.yml exec erpnext-redis \
  redis-cli ping
# Should return: PONG

# Check ERPNext site
docker compose -f docker-compose.demo-apps.yml exec erpnext \
  ls -la /home/frappe/frappe-bench/sites/erp.demo.helioncity.com/
# Should show site_config.json and other files
```

### 6. Verify volumes

```bash
# List volumes
docker volume ls | grep -E "n8n|erpnext"

# Check volume sizes
docker system df -v | grep -E "n8n|erpnext"
```

## Troubleshooting

### ERPNext not accessible

**Check site creation:**
```bash
docker compose -f docker-compose.demo-apps.yml logs erpnext | tail -50
```

**Common issues:**
- Database not ready: Wait for `erpnext-db` to be healthy
- Site creation failed: Check logs for bench errors
- Port conflict: Ensure port 8000 is not used by other services

**Manual site creation:**
```bash
docker compose -f docker-compose.demo-apps.yml exec erpnext bash
bench new-site erp.demo.helioncity.com --db-root-password ${ERPNEXT_DB_ROOT_PASSWORD} --admin-password ${ERPNEXT_ADMIN_PASSWORD} --install-app erpnext
exit
```

### n8n not accessible

**Check logs:**
```bash
docker compose -f docker-compose.demo-apps.yml logs n8n | tail -50
```

**Common issues:**
- Basic auth not configured: Verify `N8N_BASIC_AUTH_USER` and `N8N_BASIC_AUTH_PASSWORD` in `.env.demo-apps`
- Port conflict: Ensure port 5678 is not used
- Volume permissions: Check `n8n-data` volume permissions

**Reset n8n:**
```bash
docker compose -f docker-compose.demo-apps.yml down n8n
docker volume rm n8n-data
docker compose -f docker-compose.demo-apps.yml up -d n8n
```

### Traefik not discovering services

**Check Docker socket:**
```bash
docker compose exec traefik ls /var/run/docker.sock
# Should show: /var/run/docker.sock
```

**Check network:**
```bash
docker network inspect platform | jq '.[0].Containers'
# Should show erpnext, n8n, erpnext-db, erpnext-redis
```

**Restart Traefik:**
```bash
docker compose restart traefik
```

**Check Traefik logs:**
```bash
docker compose logs traefik | grep -i "erpnext\|n8n\|error"
```

### Let's Encrypt certificate issues

**Check certificate status:**
```bash
docker compose exec traefik cat /letsencrypt/acme.json | jq .
```

**Force certificate renewal:**
```bash
# Delete existing certificate
docker compose exec traefik rm /letsencrypt/acme.json

# Restart Traefik
docker compose restart traefik

# Check logs for certificate provisioning
docker compose logs traefik | grep -i "acme\|certificate"
```

## Maintenance Commands

### Stop demo apps

```bash
docker compose -f docker-compose.demo-apps.yml down
```

### Start demo apps

```bash
docker compose -f docker-compose.demo-apps.yml --env-file .env.demo-apps up -d
```

### Restart specific service

```bash
docker compose -f docker-compose.demo-apps.yml restart erpnext
docker compose -f docker-compose.demo-apps.yml restart n8n
```

### View logs

```bash
# All services
docker compose -f docker-compose.demo-apps.yml logs -f

# Specific service
docker compose -f docker-compose.demo-apps.yml logs -f erpnext
docker compose -f docker-compose.demo-apps.yml logs -f n8n
```

### Backup volumes

```bash
# Backup ERPNext sites
docker run --rm -v erpnext-sites:/data -v $(pwd):/backup \
  alpine tar czf /backup/erpnext-sites-backup-$(date +%Y%m%d).tar.gz -C /data .

# Backup n8n data
docker run --rm -v n8n-data:/data -v $(pwd):/backup \
  alpine tar czf /backup/n8n-data-backup-$(date +%Y%m%d).tar.gz -C /data .
```

### Restore volumes

```bash
# Restore ERPNext sites
docker run --rm -v erpnext-sites:/data -v $(pwd):/backup \
  alpine tar xzf /backup/erpnext-sites-backup-YYYYMMDD.tar.gz -C /data

# Restore n8n data
docker run --rm -v n8n-data:/data -v $(pwd):/backup \
  alpine tar xzf /backup/n8n-data-backup-YYYYMMDD.tar.gz -C /data
```

## Notes

- ERPNext first-time setup takes 5-10 minutes (downloads apps, creates database, etc.)
- n8n starts quickly but requires basic auth credentials
- Both services use the existing "platform" Docker network
- Traefik automatically provisions Let's Encrypt certificates
- Demo apps are isolated from main stack (separate compose file)
- ERPNext site creation is automatic but can be done manually if needed

## Rollback

If issues occur, stop demo apps without affecting main stack:

```bash
docker compose -f docker-compose.demo-apps.yml down
```

Main stack (ai-api, ui, postgres, qdrant, traefik) continues running normally.
