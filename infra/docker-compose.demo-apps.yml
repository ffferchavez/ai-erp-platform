services:
  # n8n workflow automation
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    environment:
      - N8N_HOST=${N8N_HOST:-n8n.demo.helioncity.com}
      - N8N_PROTOCOL=${N8N_PROTOCOL:-https}
      - N8N_PORT=${N8N_PORT:-5678}
      - WEBHOOK_URL=${WEBHOOK_URL:-https://n8n.demo.helioncity.com}
      - N8N_EDITOR_BASE_URL=${N8N_EDITOR_BASE_URL:-https://n8n.demo.helioncity.com}
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - NODE_ENV=production
      - GENERIC_TIMEZONE=${N8N_TIMEZONE:-UTC}
    volumes:
      - n8n-data:/home/node/.n8n
    networks:
      - platform
    labels:
      - traefik.enable=true
      - traefik.http.routers.n8n-http.rule=Host(`${N8N_HOST:-n8n.demo.helioncity.com}`)
      - traefik.http.routers.n8n-http.entrypoints=web
      - traefik.http.routers.n8n-http.middlewares=n8n-redirect
      - traefik.http.middlewares.n8n-redirect.redirectscheme.scheme=https
      - traefik.http.routers.n8n-https.rule=Host(`${N8N_HOST:-n8n.demo.helioncity.com}`)
      - traefik.http.routers.n8n-https.entrypoints=websecure
      - traefik.http.routers.n8n-https.tls=true
      - traefik.http.routers.n8n-https.tls.certresolver=letsencrypt
      - traefik.http.services.n8n.loadbalancer.server.port=5678

  # ERPNext MariaDB database
  erpnext-db:
    image: mariadb:10.11
    container_name: erpnext-db
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${ERPNEXT_DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${ERPNEXT_DB_NAME:-frappe}
      - MYSQL_USER=${ERPNEXT_DB_USER:-frappe}
      - MYSQL_PASSWORD=${ERPNEXT_DB_PASSWORD}
    volumes:
      - erpnext-db-data:/var/lib/mysql
    networks:
      - platform
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ERPNext Redis cache
  erpnext-redis:
    image: redis:7-alpine
    container_name: erpnext-redis
    restart: unless-stopped
    volumes:
      - erpnext-redis-data:/data
    networks:
      - platform
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ERPNext init container (fixes permissions)
  erpnext-init:
    image: frappe/bench:latest
    container_name: erpnext-init
    user: root
    volumes:
      - erpnext-bench:/home/frappe/frappe-bench
    networks:
      - platform
    command: >
      sh -c "
      mkdir -p /home/frappe/frappe-bench/sites /home/frappe/frappe-bench/logs &&
      chown -R frappe:frappe /home/frappe/frappe-bench &&
      chmod -R 755 /home/frappe/frappe-bench &&
      echo 'Permissions fixed successfully' &&
      exit 0
      "
    restart: "no"

  # ERPNext application (frappe/bench for site management)
  erpnext:
    image: frappe/bench:latest
    container_name: erpnext
    restart: unless-stopped
    depends_on:
      erpnext-db:
        condition: service_healthy
      erpnext-redis:
        condition: service_healthy
      erpnext-init:
        condition: service_completed_successfully
    environment:
      - DB_HOST=erpnext-db
      - DB_PORT=3306
      - REDIS_CACHE=erpnext-redis:6379
      - REDIS_QUEUE=erpnext-redis:6379
      - REDIS_SOCKETIO=erpnext-redis:6379
      - SOCKETIO_PORT=9000
      - FRAPPE_SITE=${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com}
      - FRAPPE_SITE_NAME=${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com}
      - ADMIN_PASSWORD=${ERPNEXT_ADMIN_PASSWORD}
      - INSTALL_APPS=erpnext
      - FRAPPE_VERSION=${ERPNEXT_VERSION:-v15.0.0}
      - ERPNEXT_VERSION=${ERPNEXT_VERSION:-v15.0.0}
    volumes:
      - erpnext-bench:/home/frappe/frappe-bench
    networks:
      - platform
    command: >
      bash -lc "
      mkdir -p /home/frappe/frappe-bench/logs /home/frappe/frappe-bench/sites;
      touch /home/frappe/frappe-bench/logs/bench.log 2>/dev/null || true;
      SITE_NAME='${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com}';
      if [ ! -f /home/frappe/frappe-bench/sites/apps.txt ] && [ ! -d /home/frappe/frappe-bench/apps ]; then
        echo 'Bench not initialized, initializing...';
        cd /home/frappe && bench init frappe-bench --frappe-branch ${ERPNEXT_VERSION:-v15.0.0} --skip-redis-config-generation --skip-assets --no-procfile --no-backup || exit 1;
        echo 'Bench initialized successfully';
      fi;
      cd /home/frappe/frappe-bench || exit 1;
      if [ ! -f sites/${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com}/site_config.json ]; then
        echo 'Site not found, creating new site...';
        bench new-site ${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com} --db-host erpnext-db --db-port 3306 --db-root-username root --db-root-password ${ERPNEXT_DB_ROOT_PASSWORD} --admin-password ${ERPNEXT_ADMIN_PASSWORD} --install-app erpnext || exit 1;
        echo 'Site created successfully';
      fi;
      echo 'Starting bench serve...';
      bench serve --host 0.0.0.0 --port 8000
      "
    labels:
      - traefik.enable=true
      - traefik.http.routers.erpnext-http.rule=Host(`${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com}`)
      - traefik.http.routers.erpnext-http.entrypoints=web
      - traefik.http.routers.erpnext-http.middlewares=erpnext-redirect
      - traefik.http.middlewares.erpnext-redirect.redirectscheme.scheme=https
      - traefik.http.routers.erpnext-https.rule=Host(`${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com}`)
      - traefik.http.routers.erpnext-https.entrypoints=websecure
      - traefik.http.routers.erpnext-https.tls=true
      - traefik.http.routers.erpnext-https.tls.certresolver=letsencrypt
      - traefik.http.services.erpnext.loadbalancer.server.port=8000

networks:
  platform:
    external: true
    name: platform

volumes:
  n8n-data:
    name: n8n-data
  erpnext-db-data:
    name: erpnext-db-data
  erpnext-redis-data:
    name: erpnext-redis-data
  erpnext-bench:
    name: erpnext-bench