services:
  # n8n workflow automation
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    environment:
      - N8N_HOST=${N8N_HOST:-n8n.demo.helioncity.com}
      - N8N_PROTOCOL=${N8N_PROTOCOL:-https}
      - N8N_PORT=${N8N_PORT:-5678}
      - WEBHOOK_URL=${WEBHOOK_URL:-https://n8n.demo.helioncity.com}
      - N8N_EDITOR_BASE_URL=${N8N_EDITOR_BASE_URL:-https://n8n.demo.helioncity.com}
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - NODE_ENV=production
      - GENERIC_TIMEZONE=${N8N_TIMEZONE:-UTC}
    volumes:
      - n8n-data:/home/node/.n8n
    networks:
      - platform
    labels:
      - traefik.enable=true
      - traefik.http.routers.n8n-http.rule=Host(`${N8N_HOST:-n8n.demo.helioncity.com}`)
      - traefik.http.routers.n8n-http.entrypoints=web
      - traefik.http.routers.n8n-http.middlewares=n8n-redirect
      - traefik.http.middlewares.n8n-redirect.redirectscheme.scheme=https
      - traefik.http.routers.n8n-https.rule=Host(`${N8N_HOST:-n8n.demo.helioncity.com}`)
      - traefik.http.routers.n8n-https.entrypoints=websecure
      - traefik.http.routers.n8n-https.tls=true
      - traefik.http.routers.n8n-https.tls.certresolver=letsencrypt
      - traefik.http.services.n8n.loadbalancer.server.port=5678

  # ERPNext MariaDB database
  erpnext-db:
    image: mariadb:10.6
    container_name: erpnext-db
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${ERPNEXT_DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${ERPNEXT_DB_NAME:-frappe}
      - MYSQL_USER=${ERPNEXT_DB_USER:-frappe}
      - MYSQL_PASSWORD=${ERPNEXT_DB_PASSWORD}
    volumes:
      - erpnext-db-data:/var/lib/mysql
      - ./mariadb/erpnext.cnf:/etc/mysql/conf.d/erpnext.cnf:ro
    networks:
      - platform
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ERPNext Redis cache
  erpnext-redis:
    image: redis:7-alpine
    container_name: erpnext-redis
    restart: unless-stopped
    volumes:
      - erpnext-redis-data:/data
    networks:
      - platform
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ERPNext site creator (one-time initialization)
  erpnext-site-creator:
    image: frappe/bench:latest
    container_name: erpnext-site-creator
    restart: "no"
    depends_on:
      erpnext-db:
        condition: service_healthy
      erpnext-redis:
        condition: service_healthy
    environment:
      - DB_HOST=erpnext-db
      - DB_PORT=3306
      - REDIS_CACHE=erpnext-redis:6379
      - REDIS_QUEUE=erpnext-redis:6379
      - REDIS_SOCKETIO=erpnext-redis:6379
    volumes:
      - erpnext-bench:/home/frappe
    networks:
      - platform
    command: >
      bash -lc "set -e;
      echo 'DEBUG: python version before init';
      python3 --version || true;
      if [ ! -x /home/frappe/.pyenv/versions/3.11.9/bin/python3 ] && [ ! -x /home/frappe/.pyenv/versions/3.11.8/bin/python3 ]; then
        echo 'DEBUG: installing python3.11 via pyenv';
        pyenv install 3.11.9 || pyenv install 3.11.8;
      fi;
      if [ -x /home/frappe/.pyenv/versions/3.11.9/bin/python3 ]; then
        export PYENV_VERSION=3.11.9;
      elif [ -x /home/frappe/.pyenv/versions/3.11.8/bin/python3 ]; then
        export PYENV_VERSION=3.11.8;
      fi;
      echo 'DEBUG: python version after selecting 3.11';
      python3 --version || true;
      if [ \"$$FORCE_SITE_RECREATE\" = \"1\" ]; then
        echo 'DEBUG: FORCE_SITE_RECREATE enabled, dropping site';
        cd /home/frappe/bench && bench drop-site \"${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com}\" --force --no-backup --db-root-password ${ERPNEXT_DB_ROOT_PASSWORD} || true;
        rm -rf /home/frappe/bench/sites/${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com} 2>/dev/null || true;
      fi;
      if [ ! -f /home/frappe/bench/sites/${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com}/site_config.json ]; then
        echo 'DEBUG: checking bench initialization';
        if [ ! -f /home/frappe/bench/sites/apps.txt ] || [ ! -d /home/frappe/bench/apps ]; then
          echo 'DEBUG: bench not initialized; resetting bench dir';
          if [ -d /home/frappe/bench ]; then
            find /home/frappe/bench -mindepth 1 -delete 2>/dev/null || true;
          fi;
          echo 'DEBUG: bench init';
          cd /home/frappe && bench init --skip-redis-config-generation --frappe-branch ${ERPNEXT_VERSION:-v15.0.0} bench;
        else
          echo 'DEBUG: bench already initialized';
        fi;
        if [ ! -d /home/frappe/bench/apps/erpnext ]; then
          echo 'DEBUG: fetching erpnext app';
          cd /home/frappe/bench && bench get-app erpnext https://github.com/frappe/erpnext --branch ${ERPNEXT_VERSION:-v15.0.0};
        else
          echo 'DEBUG: erpnext app already present';
        fi;
        echo 'DEBUG: bench new-site';
        cd /home/frappe/bench;
        bench new-site \"${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com}\" --db-host erpnext-db --db-port 3306 --db-root-username root --db-root-password ${ERPNEXT_DB_ROOT_PASSWORD} --admin-password ${ERPNEXT_ADMIN_PASSWORD} --install-app erpnext;
        echo 'DEBUG: site creation completed';
      else
        echo 'DEBUG: site already exists';
      fi"

  # ERPNext backend (Frappe framework)
  erpnext-backend:
    image: frappe/bench:latest
    container_name: erpnext-backend
    restart: unless-stopped
    depends_on:
      erpnext-db:
        condition: service_healthy
      erpnext-redis:
        condition: service_healthy
      erpnext-site-creator:
        condition: service_completed_successfully
    environment:
      - DB_HOST=erpnext-db
      - DB_PORT=3306
      - REDIS_CACHE=erpnext-redis:6379
      - REDIS_QUEUE=erpnext-redis:6379
      - REDIS_SOCKETIO=erpnext-redis:6379
      - SOCKETIO_PORT=9000
      - FRAPPE_SITE=${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com}
    volumes:
      - erpnext-bench:/home/frappe
    networks:
      - platform
    working_dir: /home/frappe/bench
    command: bench serve --port 8000
    labels:
      - traefik.enable=true
      - traefik.http.routers.erpnext-http.rule=Host(`${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com}`)
      - traefik.http.routers.erpnext-http.entrypoints=web
      - traefik.http.routers.erpnext-http.middlewares=erpnext-redirect
      - traefik.http.middlewares.erpnext-redirect.redirectscheme.scheme=https
      - traefik.http.routers.erpnext-https.rule=Host(`${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com}`)
      - traefik.http.routers.erpnext-https.entrypoints=websecure
      - traefik.http.routers.erpnext-https.tls=true
      - traefik.http.routers.erpnext-https.tls.certresolver=letsencrypt
      - traefik.http.services.erpnext.loadbalancer.server.port=8000

networks:
  platform:
    external: true
    name: platform

volumes:
  n8n-data:
    name: n8n-data
  erpnext-db-data:
    name: erpnext-db-data
  erpnext-redis-data:
    name: erpnext-redis-data
  erpnext-bench:
    name: erpnext-bench
