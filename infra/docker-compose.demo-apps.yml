services:
  # n8n workflow automation
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    environment:
      - N8N_HOST=${N8N_HOST:-n8n.demo.helioncity.com}
      - N8N_PROTOCOL=${N8N_PROTOCOL:-https}
      - N8N_PORT=${N8N_PORT:-5678}
      - WEBHOOK_URL=${WEBHOOK_URL:-https://n8n.demo.helioncity.com}
      - N8N_EDITOR_BASE_URL=${N8N_EDITOR_BASE_URL:-https://n8n.demo.helioncity.com}
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - NODE_ENV=production
      - GENERIC_TIMEZONE=${N8N_TIMEZONE:-UTC}
    volumes:
      - n8n-data:/home/node/.n8n
    networks:
      - platform
    labels:
      - traefik.enable=true
      - traefik.http.routers.n8n-http.rule=Host(`${N8N_HOST:-n8n.demo.helioncity.com}`)
      - traefik.http.routers.n8n-http.entrypoints=web
      - traefik.http.routers.n8n-http.middlewares=n8n-redirect
      - traefik.http.middlewares.n8n-redirect.redirectscheme.scheme=https
      - traefik.http.routers.n8n-https.rule=Host(`${N8N_HOST:-n8n.demo.helioncity.com}`)
      - traefik.http.routers.n8n-https.entrypoints=websecure
      - traefik.http.routers.n8n-https.tls=true
      - traefik.http.routers.n8n-https.tls.certresolver=letsencrypt
      - traefik.http.services.n8n.loadbalancer.server.port=5678

  # ERPNext MariaDB database
  erpnext-db:
    image: mariadb:10.11
    container_name: erpnext-db
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${ERPNEXT_DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${ERPNEXT_DB_NAME:-frappe}
      - MYSQL_USER=${ERPNEXT_DB_USER:-frappe}
      - MYSQL_PASSWORD=${ERPNEXT_DB_PASSWORD}
    volumes:
      - erpnext-db-data:/var/lib/mysql
    networks:
      - platform
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ERPNext Redis cache
  erpnext-redis:
    image: redis:7-alpine
    container_name: erpnext-redis
    restart: unless-stopped
    volumes:
      - erpnext-redis-data:/data
    networks:
      - platform
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ERPNext site creator (one-time initialization)
  erpnext-site-creator:
    image: frappe/bench:latest
    container_name: erpnext-site-creator
    restart: "no"
    depends_on:
      erpnext-db:
        condition: service_healthy
      erpnext-redis:
        condition: service_healthy
    environment:
      - DB_HOST=erpnext-db
      - DB_PORT=3306
      - REDIS_CACHE=erpnext-redis:6379
      - REDIS_QUEUE=erpnext-redis:6379
      - REDIS_SOCKETIO=erpnext-redis:6379
    volumes:
      - erpnext-bench:/home/frappe/frappe-bench
    networks:
      - platform
    command: >
      bash -c "
      set -e;
      LOG_PATH='/Users/fernandochavez/Documents/developer/ai-erp-platform/.cursor/debug.log';
      log() {
        TS=$(date +%s000);
        LINE=\"{\\\"timestamp\\\":$TS,\\\"location\\\":\\\"erpnext-site-creator\\\",\\\"message\\\":\\\"$1\\\",\\\"data\\\":$2,\\\"sessionId\\\":\\\"debug-session\\\",\\\"runId\\\":\\\"run1\\\",\\\"hypothesisId\\\":\\\"$3\\\"}\";
        echo \"$LINE\" >> \"$LOG_PATH\" 2>/dev/null || true;
        echo \"$LINE\";
      }
      # region agent log
      BENCH_DIR_EXISTS=$( [ -d /home/frappe/frappe-bench ] && echo true || echo false );
      SITES_DIR_EXISTS=$( [ -d /home/frappe/frappe-bench/sites ] && echo true || echo false );
      APPS_DIR_EXISTS=$( [ -d /home/frappe/frappe-bench/apps ] && echo true || echo false );
      APPS_TXT_EXISTS=$( [ -f /home/frappe/frappe-bench/sites/apps.txt ] && echo true || echo false );
      log \"precheck\" \"{\\\"bench_dir_exists\\\":$BENCH_DIR_EXISTS,\\\"sites_dir_exists\\\":$SITES_DIR_EXISTS,\\\"apps_dir_exists\\\":$APPS_DIR_EXISTS,\\\"apps_txt_exists\\\":$APPS_TXT_EXISTS}\" \"H1\";
      # endregion
      if [ ! -f /home/frappe/frappe-bench/sites/${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com}/site_config.json ]; then
        # region agent log
        log \"needs_init_check\" \"{\\\"site_config_exists\\\":false}\" \"H1\";
        # endregion
        if [ ! -f /home/frappe/frappe-bench/sites/apps.txt ] || [ ! -d /home/frappe/frappe-bench/apps ]; then
          # region agent log
          log \"cleanup_start\" \"{\\\"bench_dir_exists\\\":$BENCH_DIR_EXISTS}\" \"H1\";
          # endregion
          if [ -d /home/frappe/frappe-bench ]; then
            find /home/frappe/frappe-bench -mindepth 1 -delete 2>/dev/null || rm -rf /home/frappe/frappe-bench/* /home/frappe/frappe-bench/.[!.]* 2>/dev/null || true;
            rmdir /home/frappe/frappe-bench 2>/dev/null || true;
          fi
          # region agent log
          POST_CLEAN_DIR_EXISTS=$( [ -d /home/frappe/frappe-bench ] && echo true || echo false );
          log \"cleanup_done\" \"{\\\"bench_dir_exists\\\":$POST_CLEAN_DIR_EXISTS}\" \"H1\";
          # endregion
          set +e;
          cd /home/frappe && bench init --skip-redis-config-generation --frappe-branch ${ERPNEXT_VERSION:-v15.0.0} frappe-bench;
          INIT_STATUS=$?;
          set -e;
          # region agent log
          APPS_DIR_EXISTS=$( [ -d /home/frappe/frappe-bench/apps ] && echo true || echo false );
          APPS_TXT_EXISTS=$( [ -f /home/frappe/frappe-bench/sites/apps.txt ] && echo true || echo false );
          log \"bench_init_result\" \"{\\\"init_status\\\":$INIT_STATUS,\\\"apps_dir_exists\\\":$APPS_DIR_EXISTS,\\\"apps_txt_exists\\\":$APPS_TXT_EXISTS}\" \"H2\";
          # endregion
        else
          # region agent log
          log \"bench_already_initialized\" \"{\\\"apps_dir_exists\\\":$APPS_DIR_EXISTS,\\\"apps_txt_exists\\\":$APPS_TXT_EXISTS}\" \"H1\";
          # endregion
        fi
        cd /home/frappe/frappe-bench || { log \"cd_failed\" \"{\\\"path\\\":\\\"/home/frappe/frappe-bench\\\"}\" \"H3\"; exit 1; };
        set +e;
        bench new-site ${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com} \
          --db-host erpnext-db \
          --db-port 3306 \
          --db-root-username root \
          --db-root-password ${ERPNEXT_DB_ROOT_PASSWORD} \
          --admin-password ${ERPNEXT_ADMIN_PASSWORD} \
          --install-app erpnext;
        NEW_SITE_STATUS=$?;
        set -e;
        # region agent log
        log \"new_site_result\" \"{\\\"status\\\":$NEW_SITE_STATUS}\" \"H3\";
        # endregion
        if [ $NEW_SITE_STATUS -ne 0 ]; then exit $NEW_SITE_STATUS; fi
      else
        # region agent log
        log \"site_exists\" \"{\\\"site_config_exists\\\":true}\" \"H1\";
        # endregion
      fi
      "

  # ERPNext backend (Frappe framework)
  erpnext-backend:
    image: frappe/bench:latest
    container_name: erpnext-backend
    restart: unless-stopped
    depends_on:
      erpnext-db:
        condition: service_healthy
      erpnext-redis:
        condition: service_healthy
      erpnext-site-creator:
        condition: service_completed_successfully
    environment:
      - DB_HOST=erpnext-db
      - DB_PORT=3306
      - REDIS_CACHE=erpnext-redis:6379
      - REDIS_QUEUE=erpnext-redis:6379
      - REDIS_SOCKETIO=erpnext-redis:6379
      - SOCKETIO_PORT=9000
      - FRAPPE_SITE=${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com}
    volumes:
      - erpnext-bench:/home/frappe/frappe-bench
    networks:
      - platform
    working_dir: /home/frappe/frappe-bench
    command: bench serve --host 0.0.0.0 --port 8000
    labels:
      - traefik.enable=true
      - traefik.http.routers.erpnext-http.rule=Host(`${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com}`)
      - traefik.http.routers.erpnext-http.entrypoints=web
      - traefik.http.routers.erpnext-http.middlewares=erpnext-redirect
      - traefik.http.middlewares.erpnext-redirect.redirectscheme.scheme=https
      - traefik.http.routers.erpnext-https.rule=Host(`${ERPNEXT_SITE_NAME:-erp.demo.helioncity.com}`)
      - traefik.http.routers.erpnext-https.entrypoints=websecure
      - traefik.http.routers.erpnext-https.tls=true
      - traefik.http.routers.erpnext-https.tls.certresolver=letsencrypt
      - traefik.http.services.erpnext.loadbalancer.server.port=8000

networks:
  platform:
    external: true
    name: platform

volumes:
  n8n-data:
    name: n8n-data
  erpnext-db-data:
    name: erpnext-db-data
  erpnext-redis-data:
    name: erpnext-redis-data
  erpnext-bench:
    name: erpnext-bench
