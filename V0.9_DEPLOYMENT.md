# Platform v0.9 Deployment Guide

## Summary

Platform v0.9 adds chat/search quality improvements, rate limiting, and an admin panel UI.

## Changed/New Files

### New Files
1. `apps/ai-api/app/rate_limit.py` - In-memory rate limiting middleware
2. `apps/ui/app/admin/page.tsx` - Admin panel UI page
3. `V0.9_DEPLOYMENT.md` - This file

### Modified Files
1. `apps/ai-api/app/main.py` - Chat/search improvements, rate limiting, version 0.9.0
2. `apps/ui/lib/api.ts` - Added admin functions and ChatRequest fields
3. `apps/ui/app/page.tsx` - Updated navigation links
4. `apps/ui/app/documents/page.tsx` - Updated navigation links
5. `README.md` - Added v0.9 documentation section

## Deployment Commands (VPS)

```bash
# 1. Navigate to project directory
cd /opt/ai-erp-platform

# 2. Pull latest changes
git pull

# 3. Navigate to infra directory
cd infra

# 4. Rebuild and restart services
docker compose down
docker compose up -d --build

# 5. Wait for services to start
sleep 15

# 6. Verify API version
curl https://api.demo.helioncity.com/
# Should return: {"name":"ai-api","version":"0.9.0"}

# 7. Verify UI is accessible
curl -I https://demo.helioncity.com/admin
# Should return: HTTP/2 200
```

## Verification Commands

### Setup Environment Variables

```bash
export BASE=https://api.demo.helioncity.com
export API_KEY=your-secret-api-key-here
export TENANT=demo
```

### 1. Test Rate Limiting

```bash
# Make 61 requests rapidly (should get 429 on 61st request)
for i in {1..61}; do
  echo "Request $i:"
  curl -s -X POST "${BASE}/chat" \
    -H "Content-Type: application/json" \
    -d '{"message":"test"}' | head -1
  sleep 0.1
done
```

**Expected:** First 60 requests succeed, 61st returns:
```json
{"detail":"Rate limit exceeded. Try again later."}
```

### 2. Test Chat with min_score and max_citations

```bash
curl -X POST "${BASE}/chat" \
  -H "Content-Type: application/json" \
  -d "{
    \"message\": \"What are your opening hours?\",
    \"top_k\": 5,
    \"min_score\": 0.5,
    \"max_citations\": 2,
    \"tenant_id\": \"${TENANT}\"
  }"
```

**Expected Response:**
- Answer based on filtered results (score >= 0.5)
- At most 2 citations returned
- Citations sorted by score (highest first)

### 3. Test Search with min_score

```bash
curl -X POST "${BASE}/search" \
  -H "Content-Type: application/json" \
  -d "{
    \"query\": \"opening hours\",
    \"top_k\": 5,
    \"min_score\": 0.5,
    \"tenant_id\": \"${TENANT}\"
  }"
```

**Expected Response:**
- Only results with score >= 0.5
- Results sorted by score (descending)

### 4. Test Chat with Low min_score (Should Return No Info)

```bash
curl -X POST "${BASE}/chat" \
  -H "Content-Type: application/json" \
  -d "{
    \"message\": \"What is the weather today?\",
    \"min_score\": 0.9,
    \"tenant_id\": \"${TENANT}\"
  }"
```

**Expected Response:**
```json
{
  "message": "What is the weather today?",
  "answer": "I don't have enough information to answer that.",
  "citations": []
}
```

### 5. Verify Admin Panel UI

```bash
# Check admin page is accessible
curl -I https://demo.helioncity.com/admin
# Should return: HTTP/2 200

# Test admin endpoint via API (requires API key)
curl -X POST "${BASE}/admin/reset-seed" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: ${API_KEY}" \
  -d "{\"tenant_id\": \"${TENANT}\"}"
```

### 6. Verify OpenAPI Documentation

```bash
curl "${BASE}/openapi.json" | python3 -m json.tool | grep -A 10 "\"min_score\""
```

Should show `min_score` and `max_citations` fields in ChatRequest schema.

## Environment Variables

**Optional (with defaults):**
```bash
RATE_LIMIT_MAX=60                    # Default: 60 requests
RATE_LIMIT_WINDOW_SECONDS=600        # Default: 600 seconds (10 minutes)
```

**Existing (unchanged):**
- `API_KEY` - Required for admin endpoints
- `OPENAI_API_KEY` - Required for embeddings
- `DEFAULT_TENANT_ID` - Default tenant (default: "demo")

## Troubleshooting

### Rate Limit Not Working
- Check Traefik is forwarding `X-Forwarded-For` header
- Verify middleware is applied: check API logs for rate limit messages
- Test from different IPs to confirm per-IP limiting

### Chat Returns "No Information" with High min_score
- Lower `min_score` value (try 0.3 or 0.4)
- Ensure seed data exists for the tenant
- Check Qdrant search results without filter first

### Admin Panel Not Accessible
- Verify UI container is running: `docker compose ps | grep ui`
- Check Traefik routes: `curl http://localhost:8080/api/http/routers | grep ui`
- Verify UI build succeeded: `docker compose logs ui | tail -20`

## Notes

- Rate limiting resets after the time window expires
- Score filtering improves answer quality but may reduce recall
- Citation limiting reduces response noise
- All new fields are optional - existing requests work unchanged
- Rate limiting is per-IP, so shared IPs (NAT) share the limit
