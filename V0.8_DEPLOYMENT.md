# Platform v0.8 Deployment Guide

## Summary

Platform v0.8 adds admin endpoints for resetting and seeding demo tenants with a deterministic restaurant dataset.

## Changed/New Files

### New Files
1. `apps/ai-api/app/seed.py` - Seed dataset definition (8 restaurant documents)

### Modified Files
1. `apps/ai-api/app/main.py` - Added 3 admin endpoints, updated version to 0.8.0
2. `apps/ai-api/app/qdrant_client.py` - Added `delete_points_by_tenant()` function
3. `apps/ai-api/app/schema.py` - Added `delete_tenant_data()` function
4. `README.md` - Added v0.8 documentation section

## Deployment Commands (VPS)

```bash
# 1. Navigate to project directory
cd /opt/ai-erp-platform

# 2. Pull latest changes
git pull

# 3. Navigate to infra directory
cd infra

# 4. Rebuild and restart API service
docker compose down
docker compose up -d --build

# 5. Wait for services to start
sleep 10

# 6. Verify API is running
curl https://api.demo.helioncity.com/health
# Should return: {"status":"ok"}

# 7. Verify version
curl https://api.demo.helioncity.com/
# Should return: {"name":"ai-api","version":"0.8.0"}
```

## Verification Commands

### Setup Environment Variables

```bash
export BASE=https://api.demo.helioncity.com
export API_KEY=your-secret-api-key-here
export TENANT=demo
```

### 1. Test Reset Endpoint

```bash
curl -X POST "${BASE}/admin/reset" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: ${API_KEY}" \
  -d "{\"tenant_id\": \"${TENANT}\"}"
```

**Expected Response (200 OK):**
```json
{
  "status": "reset",
  "tenant_id": "demo",
  "deleted_postgres_documents": <number>,
  "deleted_postgres_chunks": <number>,
  "deleted_qdrant_points": -1
}
```

### 2. Test Seed Endpoint

```bash
curl -X POST "${BASE}/admin/seed" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: ${API_KEY}" \
  -d "{\"tenant_id\": \"${TENANT}\"}"
```

**Expected Response (201 Created):**
```json
{
  "status": "seeded",
  "tenant_id": "demo",
  "documents": [
    {
      "title": "Restaurant Overview",
      "document_id": "...",
      "chunks": 1
    },
    {
      "title": "Opening Hours",
      "document_id": "...",
      "chunks": 1
    }
    // ... 6 more documents
  ]
}
```

### 3. Test Reset-Seed Endpoint (Combined)

```bash
curl -X POST "${BASE}/admin/reset-seed" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: ${API_KEY}" \
  -d "{\"tenant_id\": \"${TENANT}\"}"
```

**Expected Response (201 Created):**
```json
{
  "status": "reset-seeded",
  "tenant_id": "demo",
  "reset": {
    "status": "reset",
    "tenant_id": "demo",
    "deleted_postgres_documents": <number>,
    "deleted_postgres_chunks": <number>,
    "deleted_qdrant_points": -1
  },
  "seed": {
    "status": "seeded",
    "tenant_id": "demo",
    "documents": [...]
  }
}
```

### 4. Verify Seed Data via Chat

After seeding, test that the data is accessible:

```bash
curl -X POST "${BASE}/chat" \
  -H "Content-Type: application/json" \
  -d "{
    \"message\": \"What are your opening hours?\",
    \"tenant_id\": \"${TENANT}\"
  }"
```

**Expected:** Should return answer mentioning "Mon-Fri 11:00-22:00" or similar.

### 5. Verify OpenAPI Documentation

```bash
curl "${BASE}/openapi.json" | python3 -m json.tool | grep -A 5 "/admin"
```

Should show all three admin endpoints.

## Troubleshooting

### Error: "Invalid API key"
- Ensure `API_KEY` environment variable is set correctly
- Check that the `X-API-Key` header matches the env var

### Error: "OPENAI_API_KEY environment variable is not set"
- Required for seeding (embeddings generation)
- Set `OPENAI_API_KEY` in `.env` file

### Error: "Failed to delete Qdrant points"
- Check Qdrant is running: `docker compose ps | grep qdrant`
- Check Qdrant logs: `docker compose logs qdrant`

### Error: "Failed to reset tenant"
- Check Postgres is running: `docker compose ps | grep postgres`
- Check Postgres logs: `docker compose logs postgres`

## Notes

- All admin endpoints require `X-API-Key` header
- Reset operations are **destructive** - data cannot be recovered
- Seed operations use OpenAI embeddings - ensure `OPENAI_API_KEY` is set
- Qdrant deletion count may return -1 (Qdrant doesn't always return count)
- Default tenant uses `DEFAULT_TENANT_ID` env var if not specified in request
